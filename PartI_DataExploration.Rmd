---
title: "Part I: Data Exploration and Prediction"
output: html_notebook
---

First, we load packages:
```{r}
library(readxl)
library(tidyverse)
library(dplyr)
library(ggplot2)
library("GGally")
library(corrplot)
library(cvTools)
library(glmnet)
library(plotmo)
library(pROC)
library(tibble)
library(modelr)
library(repr)
library(knitr)
library(stargazer)
library(ROCR)
```

Then, we load the data:
```{r}
school_demographics <- read_excel("Data/cupc1718-k12.xlsx", sheet = "School-Level CALPADS UPC Data", skip = 1)
Hg_SchoolDistricts <- read.csv("Data/Hg_SchoolDistricts.csv")

```

Next, we clean the columns:
```{r}
colnames(school_demographics) <- gsub(" ", "_", colnames(school_demographics))
colnames(Hg_SchoolDistricts) <- gsub(" ", "_", colnames(Hg_SchoolDistricts))

colnames(school_demographics) <- tolower(colnames(school_demographics))
colnames(Hg_SchoolDistricts) <- tolower(colnames(Hg_SchoolDistricts))

colnames(school_demographics) <- gsub("\r\n", "", colnames(school_demographics))
colnames(Hg_SchoolDistricts) <- gsub("\r\n", "", colnames(Hg_SchoolDistricts))

colnames(school_demographics) <- gsub("&", "", colnames(school_demographics))
colnames(Hg_SchoolDistricts) <- gsub("&", "", colnames(Hg_SchoolDistricts))

colnames(school_demographics) <- gsub("_(y/n)", "", colnames(school_demographics), fixed=TRUE)

colnames(school_demographics) <- gsub("_(el)", "", colnames(school_demographics), fixed=TRUE)

colnames(school_demographics) <- gsub("_(upc)", "", colnames(school_demographics), fixed=TRUE)

colnames(school_demographics) <- gsub("(upc)", "", colnames(school_demographics), fixed=TRUE)

```


Then, we merge the datasets:
```{r}
combined_data <- merge(school_demographics, Hg_SchoolDistricts, by.x=c("school_name", "county_name"), by.y = c("school_name", "school_county")) 

```

Next, we clean the dataset
```{r}
#select column names according to google doc

drops <- c("academic_year", "county_code", "district_code", "school_code", "charter_number", "irc", "low_grade", "high_grade", "unduplicated", "calpads_fall_1", "pscode", "district", "school_address", "school_site_name", "xmod", "rpt_unit", "water_system_county", "samp_date", "sample_loaddate", "samp_loaded", "samp_time", "pws_id")

combined_data_clean <- combined_data[ , !(names(combined_data) %in% drops)]

#remove resampled observations
combined_data_clean$ale_follow_up_action <- combined_data_clean$ale_follow_up_action %>% replace_na('NA')
combined_data_clean <- combined_data_clean[!(combined_data_clean$ale_follow_up_action == "Resampled"),]

#remove charter schools with funding type na
combined_data_clean <- combined_data_clean[!(combined_data_clean$"charter_school" == "Yes" & combined_data_clean$charter_funding_type == "N/A"),]

#remove data with NAs in the columns: total enrollment, frmp, homeless, migrant, direct certification, undup, el, results, action level exceedence, school_type
combined_data_clean %>% drop_na("total_enrollment", "free_reducedmealprogram", "homeless", "migrantprogram", "direct_certification", "unduplicatedfrpm_eligible_count", "english_learner" , "result", "action_level_exceedance", "school_type.y")

#combine multiple samples by taking max samples when multiple samples taken at a school
combined_data_clean_grouped <- combined_data_clean %>% 
  group_by(school_name, county_name) %>% 
  mutate(result.max= max(result))

combined_data_clean_grouped <-subset(combined_data_clean_grouped, result==result.max)
combined_data_clean_grouped <- unique(combined_data_clean_grouped)

#convert exceedence to binary variable (0,1)
combined_data_clean_grouped$action_level_exceedance <- ifelse(combined_data_clean_grouped$action_level_exceedance=="Yes",1,0)

```

Qualitatively establish the difference between public and charter school
Look into NSLP provision status

Charter school funding type-> drop row if funding type na, but is charter school (no nas for charter schools, no action needed)

total enrollment, frmp, homeless, migrant, direct certification, undup, el, results, action level exceedence, school_type -> dropnas

water system name, sample date, follow up status and action -> keep nas
```{r}
combined_data_clean_grouped = combined_data_clean_grouped[,!(names(combined_data_clean_grouped) =='result')]
combined_data_clean_grouped_rmna <- combined_data_clean_grouped %>% 
 drop_na(total_enrollment)  %>%
 drop_na(homeless)  %>%
 drop_na(migrantprogram)  %>%
 drop_na(direct_certification)  %>%
 drop_na(unduplicatedfrpm_eligible_count)  %>%
 drop_na(english_learner)  %>%
 drop_na(result.max)  %>%
 drop_na(action_level_exceedance)  %>%
 drop_na(school_type.y)

```

need to make ratios instead of numbers

```{r}
print(colnames(combined_data_clean_grouped_rmna))
combined_data_clean_grouped_rmna$free_reducedmealprogram =  combined_data_clean_grouped_rmna$free_reducedmealprogram/combined_data_clean_grouped_rmna$total_enrollment

combined_data_clean_grouped_rmna$foster =  combined_data_clean_grouped_rmna$foster/combined_data_clean_grouped_rmna$total_enrollment

combined_data_clean_grouped_rmna$homeless =  combined_data_clean_grouped_rmna$homeless/combined_data_clean_grouped_rmna$total_enrollment

combined_data_clean_grouped_rmna$migrantprogram =  combined_data_clean_grouped_rmna$migrantprogram/combined_data_clean_grouped_rmna$total_enrollment

combined_data_clean_grouped_rmna$direct_certification =  combined_data_clean_grouped_rmna$direct_certification/combined_data_clean_grouped_rmna$total_enrollment

combined_data_clean_grouped_rmna$unduplicatedfrpm_eligible_count=  combined_data_clean_grouped_rmna$unduplicatedfrpm_eligible_count/combined_data_clean_grouped_rmna$total_enrollment

combined_data_clean_grouped_rmna$english_learner =  combined_data_clean_grouped_rmna$english_learner /combined_data_clean_grouped_rmna$total_enrollment

combined_data_clean_grouped_rmna$calpads_unduplicated_pupil_count =  combined_data_clean_grouped_rmna$calpads_unduplicated_pupil_count /combined_data_clean_grouped_rmna$total_enrollment

combined_data_clean_grouped_rmna <- combined_data_clean_grouped_rmna %>%
  rename(school_type = school_type.x)

print(unique(combined_data_clean_grouped_rmna$school_type))
high_columns <- c("High Schools (Public)", "High Schools In 1 School Dist. (Public)")
middle_columns <- c("Intermediate/Middle Schools (Public)", "Junior High Schools (Public)")
elem_columns <- c("Elemen Schools In 1 School Dist. (Public)", "Elementary Schools (Public)")
other_columns <- c("Alternative Schools of Choice", "Continuation High Schools", "District Community Day Schools", "K-12 Schools (Public)", "Opportunity Schools", "Preschool", "County Community", "Special Education Schools (Public)", "Juvenile Court Schools")

combined_data_clean_grouped_rmna$school_type[combined_data_clean_grouped_rmna$school_type %in% high_columns] <- "High"
combined_data_clean_grouped_rmna$school_type[combined_data_clean_grouped_rmna$school_type %in% middle_columns] <- "Middle"
combined_data_clean_grouped_rmna$school_type[combined_data_clean_grouped_rmna$school_type %in% elem_columns] <- "Elem"
combined_data_clean_grouped_rmna$school_type[combined_data_clean_grouped_rmna$school_type %in% other_columns] <- "Other"

has_provisions <- c("Provision 3", "Provision 2", "Provision 1", "CEP", "Breakfast Provision 2", "Lunch Provision 2")
combined_data_clean_grouped_rmna$nslp_provision_status[combined_data_clean_grouped_rmna$nslp_provision_status %in% has_provisions] <- "Provisions"

  
```

Next we allocate our training and test sets
-set aside test and training data (80-20, do CV, we dont have infinite data)
```{r}
#calculate the number of observations that should be in our training set
size_training = round(.8*nrow(combined_data_clean_grouped_rmna), digits = 0)

#allocate training and test data
in.train = sample(nrow(combined_data_clean_grouped_rmna), size = size_training)
train = combined_data_clean_grouped_rmna[in.train, ]
test = combined_data_clean_grouped_rmna[-in.train, ]

```

Next we start visualizing our training data
```{r}
ggplot(data = train) + geom_bar(mapping = aes(x=county_name)) + theme(axis.text.x = element_text(angle = 90))
ggplot(data = train) + geom_bar(mapping = aes(x=school_type)) + theme(axis.text.x = element_text(angle = 90)) #seeing the number of schools that are categorized weirdly, we may want to combine #I agree we can combine some of these categories 
ggplot(data = train) + geom_bar(mapping = aes(x=school_type.y)) + theme(axis.text.x = element_text(angle = 90)) 
#I think we can remove school type y
ggplot(data = train) + geom_bar(mapping = aes(x=charter_funding_type)) + theme(axis.text.x = element_text(angle = 90))
ggplot(data = train) + geom_bar(mapping = aes(x=ale_follow_up_status)) + theme(axis.text.x = element_text(angle = 90)) #doesn't look like we have a ton of data on this...
#This is only if there was an exceedence! so i think that is why there are so few 

```



Things to viz:

-Density plots for continuous
```{r}
cont.colnames <- train %>% select_if(is.numeric) %>% colnames()
fact.colnames <- train %>% select_if(negate(is.numeric)) %>% colnames()
print(cont.colnames)

ggplot(data=train)+
  geom_density(aes(free_reducedmealprogram))

ggplot(data=train)+
  geom_density(aes(foster))

ggplot(data=train)+
  geom_density(aes(homeless))

ggplot(data=train)+
  geom_density(aes(migrantprogram))

ggplot(data=train)+
  geom_density(aes(direct_certification))

ggplot(data=train)+
  geom_density(aes(unduplicatedfrpm_eligible_count))

ggplot(data=train)+
  geom_density(aes(english_learner))

ggplot(data=train)+
  geom_density(aes(calpads_unduplicated_pupil_count))

ggplot(data=train)+
  geom_density(aes(result.max))

ggplot(data=train)+
  geom_density(aes(log(result.max)))
```

-barplots to describe the population

```{r}
print(cont.colnames)

ggplot(data=train)+
  geom_bar(aes(district_type))+ theme(axis.text.x = element_text(angle = 45, hjust=1))

ggplot(data=train)+
  geom_bar(aes(school_type))+ theme(axis.text.x = element_text(angle = 45, hjust=1))

ggplot(data=train)+
  geom_bar(aes(educational_option_type))+ theme(axis.text.x = element_text(angle = 45, hjust=1))

ggplot(data=train)+
  geom_bar(aes(nslp_provision_status))

ggplot(data=train)+
  geom_bar(aes(charter_funding_type))

ggplot(data=train)+
  geom_bar(aes(school_type.y))

ggplot(data=train)+
  geom_bar(aes(action_level_exceedance))

ggplot(data=train)+
  geom_bar(aes(charter_school))

```
grouped histogram of results for factors
```{r}
ggplot(data=train)+
  geom_violin(aes(x=district_type, y=log(result.max)))+ theme(axis.text.x = element_text(angle = 45, hjust=1))

ggplot(data=train)+
  geom_violin(aes(x=school_type, y=log(result.max)))+ theme(axis.text.x = element_text(angle = 45, hjust=1))
  
ggplot(data=train)+
  geom_violin(aes(x=educational_option_type, y=log(result.max)))+ theme(axis.text.x = element_text(angle = 45, hjust=1))

ggplot(data=train)+
  geom_violin(aes(x=nslp_provision_status, y=log(result.max)))+ theme(axis.text.x = element_text(angle = 45, hjust=1))

ggplot(data=train)+
  geom_violin(aes(x=charter_funding_type, y=log(result.max)))+ theme(axis.text.x = element_text(angle = 45, hjust=1))


ggplot(data=train)+
  geom_violin(aes(x=charter_school, y=log(result.max)))+ theme(axis.text.x = element_text(angle = 45, hjust=1))


```


-scatterplot/ Correlation matrix continuous variables

```{r}
train.num <- train %>% select_if(is.numeric)
ggpairs(train.num[,c(3:13)], lower = list(continuous = wrap("smooth", alpha = 0.3, size=0.1)))

M = cor(train.num[,c(3:13)])
corrplot(M)+ theme(axis.text.x = element_text(angle = 45, hjust=1))

```
-covariates that seem important:
  -undupliccated frpm
  -foster
  -homeless
  -migrant program
  -english_learner_(el)
  -charter school
  -nslp_provision_status
  -school.type.x
  
```{r}
regression_columns <- c('school_type', 'unduplicatedfrpm_eligible_count', 'foster', 'homeless', 'migrantprogram', 'english_learner', 'charter_school', 'nslp_provision_status', 'result.max')

classification_columns <- c('school_type', 'unduplicatedfrpm_eligible_count', 'foster', 'homeless', 'migrantprogram', 'english_learner', 'charter_school', 'nslp_provision_status', 'action_level_exceedance')

train.regression <- train[ , (names(train) %in% regression_columns)]
train.classification <- train[ , (names(train) %in% classification_columns)]

#use glmnet to do ridge
school_type_rm <- subset(train, select = -c(school_type.y, calpads_fall_1_certification_status, school_name, county_name, district_name, water_system_name, sample_date, action_level_exceedance, ale_follow_up_action, ale_follow_up_status))

x <- model.matrix(result.max ~ .,school_type_rm)[,-1]
y <- train$result.max
grid <- 10^seq(1, -2, length = 10)
ridge.mod <- glmnet(x, y, alpha = 0, lambda = grid)

coef(ridge.mod)
plot_glmnet(ridge.mod)

```

  
-Prediction model
  -interpretable model
    -dont use knn bc not interpretable
    -use lasso, ridge, regular OLS
  -acceptable performance: RMSE
    -baseline "naive" estimators: 
      - prediction: mean result

```{r}
set.seed(1)
lm.fit <- lm(result.max ~ ., data=train.regression)
rmse.train = sqrt(mean(lm.fit$residuals^2))
#train.regression <- fold(train.regression, k = 2, cat_col = '')
cv1 <- cvFit(lm.fit, data=train.regression, y=train.regression$result.max, K = 10, seed=1)
print(cv1)
#cv3 <- cvFit(lm.fit, data=train.regression, y=train.regression$result.max, K = 100, seed=1)
```


-Classification model
    -logistic regression
    -dont use knn bc not interpretable
  -objective: prioritize low false negatives (check confusion matrix for appropriate metric)
  -baseline: "No exceedance"
```{r}
school_type_rm <- subset(train, select = -c(school_type.y, calpads_fall_1_certification_status, school_name, county_name, district_name, water_system_name, sample_date, result.max, ale_follow_up_action, ale_follow_up_status))

x <- model.matrix(action_level_exceedance ~ .,school_type_rm)[,-1]
y <- school_type_rm$action_level_exceedance
logistic.mod <- glm(y~x, data= school_type_rm, family = binomial())
summary(logistic.mod)


x <- model.matrix(action_level_exceedance ~ .,train.classification)[,-1]
y <- train.classification$action_level_exceedance
logistic.mod.2 <- glm(y~x, data= train.classification, family = binomial())
summary(logistic.mod.2)

full_model = glm(action_level_exceedance~school_type+unduplicatedfrpm_eligible_count+foster+homeless+migrantprogram+english_learner+charter_school+nslp_provision_status, data= train.classification, family = binomial())
summary(full_model)
null_model = glm(action_level_exceedance ~ 1, family = binomial(), data = train.classification)
summary(null_model)
step(null_model, list(upper = full_model), direction = 'forward')
best_aic_model = glm(action_level_exceedance ~ charter_school + unduplicatedfrpm_eligible_count + 
    english_learner, family = binomial(), data = train.classification)

fitted_model = fitted(best_aic_model)


roc_data = data.frame(fit = fitted_model, obs = train.classification$action_level_exceedance)
my_roc = roc(roc_data$obs ~ roc_data$fit, plot = FALSE)
cat("AUC = ", toString(auc(my_roc)))
options(repr.plot.width=4, repr.plot.height=4)
plot(my_roc)

threshold <- coords(my_roc, "best", ret = "threshold")

pred <- prediction(roc_data$fit,roc_data$obs)
acc.perf = performance(pred, measure = "acc")
plot(acc.perf)

tpr.perf = performance(pred, measure = "tpr")
plot(tpr.perf)

threshold2 <- 0.02
table(fitted_model > threshold$threshold, train.classification$action_level_exceedance)
table(fitted_model > threshold2, train.classification$action_level_exceedance)

```

```{r}
closed_all <- stargazer(M1Cfe.a, M1Cfe.b, M1Cfe.c, M1Cfe.e, M2Cfe.a, M2Cfe.b, M2Cfe.d,M3Cfe.a, M3Cfe.b,  M3Cfe.d, title="All Closed Systems", align=TRUE, dep.var.labels=c("Cooling Water Consumption Intensity (Ln)"), omit.stat=c("adj.rsq", "f"), no.space=TRUE, type = "html")
writeLines(text = closed_all, con = '/Users/alisonfritz/Box/We3 Lab/05_Active_Research_Projects/01_research for cooling water/04_Processed_Data/Closed_all_log_dropped.htm')
```



-Find bias/variance trade-off plot for model selection